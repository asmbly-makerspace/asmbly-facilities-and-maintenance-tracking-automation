name: Deploy Production Pipeline

on:
  push:
    branches:
      - main # This pipeline triggers on pushes to the 'main' branch

env:
  AWS_REGION: us-east-2 # Set your desired AWS region here
  SAM_STACK_NAME: AsmblyFacilitiesMaintTrackingStack-prod

jobs:
  # =================================================================
  # JOB 1: Deploy the SAM application to AWS
  # =================================================================
  deploy:
    name: Deploy to AWS
    environment: prod
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for OIDC if you use it
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::110104886034:role/GitHub-OIDC-facilities-automation-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup SAM CLI
        uses: aws-actions/setup-sam@v2

      - name: Build SAM Application
        # The --use-container flag builds your functions in a Docker container
        # that mimics the Lambda execution environment.
        run: sam build --use-container

      - name: Deploy SAM Application
        run: |
          sam deploy \
            --stack-name ${{ env.SAM_STACK_NAME }} \
            --parameter-overrides Stage=prod \
            --no-fail-on-empty-changeset \
            --resolve-s3 \
            --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND \
            --region ${{ env.AWS_REGION }}

  # =================================================================
  # JOB 2: Update Slack App Configuration
  # This job runs only after the 'deploy' job succeeds.
  # =================================================================
  update-slack-url:
    name: Update Slack Event URL
    environment: prod
    needs: deploy
    if: secrets.SLACK_MAINTENANCE_BOT_APP_ID != '' && secrets.SLACK_APP_CONFIG_TOKEN != ''
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::110104886034:role/GitHub-OIDC-facilities-automation-deploy
          aws-region: ${{ env.AWS_REGION }}

      - name: Update Slack App Manifest
        env:
          # This is a special token for updating app manifests.
          # Store it as a secret in your GitHub repository settings.
          SLACK_MAINTENANCE_BOT_APP_ID: ${{ secrets.SLACK_MAINTENANCE_BOT_APP_ID }}
          SLACK_APP_CONFIG_TOKEN: ${{ secrets.SLACK_APP_CONFIG_TOKEN }}
        run: |
          echo "Fetching API Gateway URL from CloudFormation stack outputs..."
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name ${{ env.SAM_STACK_NAME }} \
            --query "Stacks[0].Outputs[?OutputKey=='FacilitiesApiUrl'].OutputValue" \
            --output text)

          if [ -z "$API_URL" ]; then
            echo "::error::Failed to retrieve API Gateway URL from stack outputs."
            exit 1
          fi

          EVENT_SUBSCRIPTION_URL="${API_URL}/slack/events"
          echo "New Event Subscription URL: $EVENT_SUBSCRIPTION_URL"

          echo "Fetching current Slack app manifest..."
          MANIFEST_RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: Bearer $SLACK_APP_CONFIG_TOKEN" \
            "https://slack.com/api/apps.manifest.export?app_id=${{ secrets.SLACK_MAINTENANCE_BOT_APP_ID }}")
          
          HTTP_CODE=$(echo "$MANIFEST_RESPONSE" | tail -n1)
          MANIFEST_BODY=$(echo "$MANIFEST_RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ne 200 ] || ! echo "$MANIFEST_BODY" | jq -e '.ok == true' > /dev/null; then
            echo "::error::Failed to fetch Slack manifest. HTTP Code: $HTTP_CODE"
            echo "Response: $MANIFEST_BODY"
            exit 1
          fi

          MANIFEST_JSON=$(echo "$MANIFEST_BODY" | jq -r '.manifest')

          echo "Updating manifest with new request_url..."
          UPDATED_MANIFEST_JSON=$(echo "$MANIFEST_JSON" | jq --arg url "$EVENT_SUBSCRIPTION_URL" \
            '.features.event_subscriptions.request_url = $url')

          echo "Pushing updated manifest to Slack..."
          UPDATE_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST -H "Authorization: Bearer $SLACK_APP_CONFIG_TOKEN" \
            -H "Content-Type: application/json; charset=utf-8" \
            --data "{\"app_id\": \"${{ secrets.SLACK_MAINTENANCE_BOT_APP_ID }}\", \"manifest\": $UPDATED_MANIFEST_JSON}" \
            "https://slack.com/api/apps.manifest.update")

          HTTP_CODE=$(echo "$UPDATE_RESPONSE" | tail -n1)
          UPDATE_BODY=$(echo "$UPDATE_RESPONSE" | sed '$d')

          if [ "$HTTP_CODE" -ne 200 ] || ! echo "$UPDATE_BODY" | jq -e '.ok == true' > /dev/null; then
            echo "::error::Failed to update Slack manifest. HTTP Code: $HTTP_CODE"
            echo "Response: $UPDATE_BODY"
            exit 1
          fi

          echo "Slack manifest updated successfully!"